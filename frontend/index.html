<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Analizador de Espectro - Profesional</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* üé® PALETA DE COLORES (se mantiene igual) */
    :root {
      --color1: #595b5a;
      --color2: #14c3a2;
      --color3: #0de5a8;
      --color4: #7cf49a;
      --color5: #b8fd99;
      --bg-dark: #1a1a1a;
      --bg-card: #2d2d2d;
      --text-light: #ffffff;
      --text-muted: #cccccc;
      --punto-maximo: #ff6b6b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, #2d2d2d 100%);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 15px;
      border-left: 5px solid var(--color2);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .header h1 {
      color: var(--color4);
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .form-container {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border-left: 5px solid var(--color3);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      color: var(--color5);
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 0.95em;
    }

    .form-group input {
      padding: 12px 15px;
      border: 2px solid var(--color1);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: var(--text-light);
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--color2);
      box-shadow: 0 0 10px rgba(20, 195, 162, 0.3);
      background: rgba(255,255,255,0.15);
    }

    .btn-generar {
      background: linear-gradient(135deg, var(--color2) 0%, var(--color3) 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(20, 195, 162, 0.3);
      display: block;
      margin: 0 auto;
    }

    .btn-generar:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(20, 195, 162, 0.4);
    }

    .btn-secundario {
      background: linear-gradient(135deg, var(--color4) 0%, var(--color5) 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn-eliminar {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
      padding-left: 5px; 
      margin-left: 10px;
    }

    .se√±al-item {
      background: rgba(255,255,255,0.05);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid var(--color3);
    }

    .se√±al-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      
    }

    .se√±al-title {
      color: var(--color4);
      font-weight: 600;
      font-size: 1.1em;
    }

    .chart-container {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border-left: 5px solid var(--color4);
    }

    .chart-title {
      color: var(--color4);
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.5em;
    }

    #espectroChart {
      width: 100% !important;
      height: 400px !important;
    }

    .results-container {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      border-left: 5px solid var(--color5);
    }

    .results-title {
      color: var(--color5);
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .results-content {
      background: rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--color1);
    }

    .result-item {
      margin-bottom: 10px;
      padding: 8px;
      background: rgba(20, 195, 162, 0.1);
      border-radius: 5px;
      border-left: 3px solid var(--color2);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .loading-spinner {
      border: 4px solid var(--color1);
      border-top: 4px solid var(--color2);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .header h1 {
        font-size: 2em;
      }
      .container {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>üìä Analizador de Espectro RF</h1>
      <p>Visualizaci√≥n profesional de espectros de ruido y se√±al en tiempo real</p>
    </header>

    <section class="form-container">
      <form id="paramsForm">
        <div class="form-grid">
          <div class="form-group">
            <label>üå°Ô∏è Temperatura (K):</label>
            <input type="number" step="any" name="temperatura" value="290" required>
          </div>
          <div class="form-group">
            <label>üì° Ancho de banda (Hz):</label>
            <input type="number" step="any" name="ancho_banda" value="1000000" required>
          </div>
        </div>

        <!-- SECCI√ìN DE SE√ëALES DIN√ÅMICAS -->
        <div id="se√±ales-container">
          <div class="se√±al-item" data-se√±al-id="1">
            <div class="se√±al-header">
              <span class="se√±al-title">üì° Se√±al 1</span>
              <button type="button" class="btn-eliminar" onclick="eliminarSe√±al(1)">üóëÔ∏è Eliminar</button>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>üéØ Frecuencia de la se√±al (Hz):</label>
                <input type="number" step="any" name="frecuencia_senal_1" value="200" required>
              </div>
              <div class="form-group">
                <label>‚ö° PIRE (dBm):</label>
                <input type="number" step="any" name="pire_dbm_1" value="45" required>
              </div>
              <div class="form-group">
                <label>üîç Ancho de banda de la se√±al (Hz):</label>
                <input type="number" name="ancho_banda_senal_1" value="6" required>
              </div>
            </div>
          </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
          <button type="button" class="btn-secundario" onclick="a√±adirSe√±al()">‚ûï A√±adir Otra Se√±al</button>
        </div>

        <button type="submit" class="btn-generar">üöÄ Generar Gr√°fica del Espectro</button>
      </form>
    </section>

    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <p>Procesando espectro...</p>
    </div>

    <section class="chart-container">
      <h2 class="chart-title">üìà Gr√°fica del Espectro (dBm por bin)</h2>
      <canvas id="espectroChart"></canvas>
    </section>

    <section class="results-container">
      <h3 class="results-title">üìä Resultados del An√°lisis</h3>
      <div class="results-content">
        <div id="ruidoResultados" class="result-item">-- Esperando datos --</div>
        <div id="anchoBandaResultados" class="result-item">-- Ancho de banda -3dB aparecer√° aqu√≠ --</div>
      </div>
    </section>
  </div>

  <script>
    const form = document.getElementById('paramsForm');
    const ctx = document.getElementById('espectroChart').getContext('2d');
    const loading = document.getElementById('loading');
    const se√±alesContainer = document.getElementById('se√±ales-container');
    let chart = null;
    let contadorSe√±ales = 1;

    // üé® COLORS PARA M√öLTIPLES SE√ëALES
    const coloresSe√±ales = [
      '#0de5a8', '#ff6b6b', '#4dabf7', '#ffa94d', '#da77f2', 
      '#69db7c', '#ff8787', '#3bc9db', '#ffd43b', '#cc5de8'
    ];

    const coloresPuntos3dB = [
      '#A020F0', '#FF6B6B', '#4DABF7', '#FFA94D', '#DA77F2',
      '#69DB7C', '#FF8787', '#3BC9DB', '#FFD43B', '#CC5DE8'
    ];

    // ‚ûï FUNCI√ìN PARA A√ëADIR NUEVA SE√ëAL
    function a√±adirSe√±al() {
      contadorSe√±ales++;
      const nuevaSe√±al = document.createElement('div');
      nuevaSe√±al.className = 'se√±al-item';
      nuevaSe√±al.setAttribute('data-se√±al-id', contadorSe√±ales);
      
      const colorIndex = (contadorSe√±ales - 1) % coloresSe√±ales.length;
      
      nuevaSe√±al.innerHTML = `
        <div class="se√±al-header">
          <span class="se√±al-title">üì° Se√±al ${contadorSe√±ales}</span>
          <button type="button" class="btn-eliminar" onclick="eliminarSe√±al(${contadorSe√±ales})">üóëÔ∏è Eliminar</button>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>üéØ Frecuencia de la se√±al (Hz):</label>
            <input type="number" step="any" name="frecuencia_senal_${contadorSe√±ales}" value="${200 + (contadorSe√±ales - 1) * 50}" required>
          </div>
          <div class="form-group">
            <label>‚ö° PIRE (dBm):</label>
            <input type="number" step="any" name="pire_dbm_${contadorSe√±ales}" value="${45 - (contadorSe√±ales - 1) * 5}" required>
          </div>
          <div class="form-group">
            <label>üîç Ancho de banda de la se√±al (Hz):</label>
            <input type="number" name="ancho_banda_senal_${contadorSe√±ales}" value="6" required>
          </div>
        </div>
      `;
      
      se√±alesContainer.appendChild(nuevaSe√±al);
    }

    // üóëÔ∏è FUNCI√ìN PARA ELIMINAR SE√ëAL
    function eliminarSe√±al(id) {
      if (contadorSe√±ales > 1) {
        const se√±al = document.querySelector(`[data-se√±al-id="${id}"]`);
        if (se√±al) {
          se√±al.remove();
          // Reorganizar los IDs si es necesario
          const se√±alesRestantes = document.querySelectorAll('.se√±al-item');
          contadorSe√±ales = se√±alesRestantes.length;
        }
      } else {
        alert('Debe haber al menos una se√±al');
      }
    }

    // üì° OBTENER DATOS DE TODAS LAS SE√ëALES
    function obtenerDatosSe√±ales() {
      const se√±ales = [];
      const elementosSe√±ales = document.querySelectorAll('.se√±al-item');
      
      elementosSe√±ales.forEach((elemento, index) => {
        const id = elemento.getAttribute('data-se√±al-id');
        const frecuencia = parseFloat(elemento.querySelector(`input[name="frecuencia_senal_${id}"]`).value);
        const pire = parseFloat(elemento.querySelector(`input[name="pire_dbm_${id}"]`).value);
        const anchoBanda = parseFloat(elemento.querySelector(`input[name="ancho_banda_senal_${id}"]`).value);
        
        se√±ales.push({
          id: id,
          frecuencia: frecuencia,
          pire: pire,
          ancho_banda: anchoBanda,
          color: coloresSe√±ales[index % coloresSe√±ales.length],
          colorPuntos: coloresPuntos3dB[index % coloresPuntos3dB.length]
        });
      });
      
      return se√±ales;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      loading.style.display = 'block';

      const fd = new FormData(form);
      const se√±ales = obtenerDatosSe√±ales();
      
      const payload = {
        temperatura: parseFloat(fd.get('temperatura')),
        ancho_banda: parseFloat(fd.get('ancho_banda')),
        se√±ales: se√±ales
      };

      try {
        const resp = await fetch('/api/espectro', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) throw new Error('Error al generar espectro');
        const data = await resp.json();
        await procesarDatosEspectro(data, se√±ales);

      } catch (error) {
        alert('‚ùå Error: ' + error.message);
        console.error('Error:', error);
      } finally {
        loading.style.display = 'none';
      }
    });

    function encontrarIndiceMasCercano(freqs, frecuenciaObjetivo) {
      let indiceMasCercano = 0;
      let diferenciaMinima = Math.abs(freqs[0] - frecuenciaObjetivo);

      for (let i = 1; i < freqs.length; i++) {
        const diferencia = Math.abs(freqs[i] - frecuenciaObjetivo);
        if (diferencia < diferenciaMinima) {
          diferenciaMinima = diferencia;
          indiceMasCercano = i;
        }
      }
      return indiceMasCercano;
    }

    // üéØ FUNCI√ìN PARA COMBINAR TODAS LAS SE√ëALES EN UNA SOLA GR√ÅFICA
    function combinarSe√±ales(data, se√±ales) {
      const freqs = data.freqs;
      let se√±alCombinada = new Array(freqs.length).fill(-Infinity);
      
      // Combinar todas las se√±ales tomando el valor m√°ximo en cada frecuencia
      se√±ales.forEach(se√±al => {
        const se√±alData = data[`se√±al_${se√±al.id}_dbm`] || [];
        se√±alData.forEach((valor, index) => {
          if (valor > se√±alCombinada[index]) {
            se√±alCombinada[index] = valor;
          }
        });
      });

      return se√±alCombinada;
    }

    async function procesarDatosEspectro(data, se√±ales) {
      const freqs = data.freqs;

      // üìà ACTUALIZAR RESULTADOS DE RUIDO
      const ruidoWatts = data.ruido_total_watts;
      const ruidoDbm = data.ruido_total_dbm;
      document.getElementById('ruidoResultados').innerHTML = `
        <strong>üîä Ruido Total:</strong><br>
        <span style="color: #0de5a8">${ruidoWatts.toExponential(4)} W</span><br>
        <span style="color: #0de5a8">${ruidoDbm} dBm</span>
      `;

      // üéØ CONVERSI√ìN DE UNIDADES
      let factor = 1;
      let unidad = 'Hz';
      const maxF = Math.max(...freqs);
      if (maxF >= 1e9) { factor = 1e-9; unidad = 'GHz'; }
      else if (maxF >= 1e6) { factor = 1e-6; unidad = 'MHz'; }
      else if (maxF >= 1e3) { factor = 1e-3; unidad = 'kHz'; }

      const labels = freqs.map(f => (f * factor).toFixed(6));

      // üéØ COMBINAR TODAS LAS SE√ëALES EN UNA SOLA GR√ÅFICA
      const se√±alCombinada = combinarSe√±ales(data, se√±ales);

      // üóëÔ∏è DESTRUIR CHART ANTERIOR SI EXISTE
      if (chart) chart.destroy();

      // üé® PREPARAR DATASETS PARA CHART.JS
      const datasets = [];

      // 1. A√ëADIR LA SE√ëAL COMBINADA (√öNICA L√çNEA)
      datasets.push({
        label: 'üìä Espectro Combinado',
        data: se√±alCombinada,
        borderWidth: 3,
        borderColor: '#0de5a8',
        backgroundColor: 'transparent',
        fill: false,
        pointRadius: 0,
        tension: 0.4,
        order: 100
      });

      // 2. A√ëADIR PUNTOS DE REFERENCIA PARA CADA SE√ëAL
      se√±ales.forEach((se√±al, index) => {
        const fLeft = data[`se√±al_${se√±al.id}_f_left`];
        const fRight = data[`se√±al_${se√±al.id}_f_right`];
        const nivel3db = data[`se√±al_${se√±al.id}_nivel_3db`];

        // Punto m√°ximo de la se√±al
        const indicePuntoMaximo = encontrarIndiceMasCercano(freqs, se√±al.frecuencia);
        const puntoMaximoData = new Array(se√±alCombinada.length).fill(null);
        puntoMaximoData[indicePuntoMaximo] = se√±alCombinada[indicePuntoMaximo];

        datasets.push({
          label: `üìç Se√±al ${se√±al.id} - Par√°metros`,
          data: puntoMaximoData,
          borderWidth: 0,
          pointBackgroundColor: se√±al.color,
          pointBorderColor: '#ffffff',
          pointBorderWidth: 3,
          pointRadius: 6,
          pointHoverRadius: 10,
          showLine: false,
          order: 90 - index
        });

        // Puntos -3 dB si existen
        if (fLeft && fRight && nivel3db) {
          const indiceIzquierdo = encontrarIndiceMasCercano(freqs, fLeft);
          const indiceDerecho = encontrarIndiceMasCercano(freqs, fRight);
          
          const puntos3dBData = new Array(se√±alCombinada.length).fill(null);
          puntos3dBData[indiceIzquierdo] = nivel3db;
          puntos3dBData[indiceDerecho] = nivel3db;

          datasets.push({
            label: `üíú Se√±al ${se√±al.id} -3 dB`,
            data: puntos3dBData,
            borderWidth: 0,
            pointBackgroundColor: se√±al.colorPuntos,
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 8,
            showLine: false,
            order: 80 - index
          });
        }
      });

      // üé® CREAR NUEVO CHART CON SE√ëAL COMBINADA
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
            axis: 'x'
          },
          scales: {
            x: {
              title: {
                display: true,
                text: `Frecuencia (${unidad})`,
                color: 'rgba(184, 253, 153, 0.1)',
                font: { size: 14, weight: 'bold' }
              },
              grid: { color: 'rgba(184, 253, 153, 0.1)' },
              ticks: {
                maxTicksLimit: 12,
                color: 'rgba(184, 253, 153, 0.1)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Potencia (dBm)',
                color: 'rgba(184, 253, 153, 0.1)',
                font: { size: 14, weight: 'bold' }
              },
              grid: { color: 'rgba(184, 253, 153, 0.1)' },
              ticks: { color: 'rgba(184, 253, 153, 0.1)' }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                color: 'rgba(184, 253, 153, 0.1)',
                font: { size: 11 },
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(45, 45, 45, 0.95)',
              borderColor: 'rgba(184, 253, 153, 0.1)',
              borderWidth: 2,
              displayColors: true,
              callbacks: {
                label: function (context) {
                  const label = context.dataset.label || '';
                  
                  if (label.includes('Par√°metros')) {
                    const se√±alId = label.match(/Se√±al (\d+)/)[1];
                    const se√±al = se√±ales.find(s => s.id === se√±alId);
                    if (se√±al) {
                      return [
                        `Frecuencia: ${se√±al.frecuencia} Hz`,
                        `PIRE: ${se√±al.pire} dBm`
                      ];
                    }
                  } else if (label.includes('-3 dB')) {
                    const se√±alId = label.match(/Se√±al (\d+)/)[1];
                    const se√±al = se√±ales.find(s => s.id === se√±alId);
                    if (se√±al) {
                      const fLeft = data[`se√±al_${se√±al.id}_f_left`];
                      const fRight = data[`se√±al_${se√±al.id}_f_right`];
                      const nivel3db = data[`se√±al_${se√±al.id}_nivel_3db`];
                      
                      if (context.dataIndex === encontrarIndiceMasCercano(freqs, fLeft)) {
                        return [
                          `Frecuencia: ${fLeft} Hz`,
                          `Potencia: ${nivel3db} dBm (-3 dB)`
                        ];
                      } else if (context.dataIndex === encontrarIndiceMasCercano(freqs, fRight)) {
                        return [
                          `Frecuencia: ${fRight} Hz`,
                          `Potencia: ${nivel3db} dBm (-3 dB)`
                        ];
                      }
                    }
                  }
                  return `Potencia: ${context.parsed.y.toFixed(2)} dBm`;
                },
                title: function (context) {
                  const label = context[0].dataset.label || '';
                  
                  if (label.includes('Par√°metros')) {
                    return `üéØ Par√°metros Ingresados`;
                  } else if (label.includes('-3 dB')) {
                    return `üìè Ancho de Banda -3 dB`;
                  } else {
                    const index = context[0].dataIndex;
                    const frecuenciaActual = freqs[index] * factor;
                    return `Frecuencia: ${frecuenciaActual.toFixed(6)} ${unidad}`;
                  }
                }
              }
            }
          }
        }
      });

      // üìä ACTUALIZAR INFORMACI√ìN DE ANCHO DE BANDA
      let infoAnchoBanda = '<strong>üìè Anchos de Banda -3 dB:</strong><br>';
      se√±ales.forEach(se√±al => {
        const fLeft = data[`se√±al_${se√±al.id}_f_left`];
        const fRight = data[`se√±al_${se√±al.id}_f_right`];
        
        if (fLeft && fRight) {
          const anchoBanda = fRight - fLeft;
          infoAnchoBanda += `
            <span style="color: ${se√±al.colorPuntos}">Se√±al ${se√±al.id}: ${(anchoBanda * factor).toFixed(6)} ${unidad}</span><br>
          `;
        }
      });
      
      document.getElementById('anchoBandaResultados').innerHTML = infoAnchoBanda;
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Analizador de Espectro RF - Listo!');
    });
  </script>
</body>
</html>